// src/api/authApi.ts

const USERS_KEY = "shopflow_users";
const SESSION_KEY = "shopflow_session_user";

type Role = "admin" | "regular";

export type User = {
  id: string;
  email: string;
  role: Role;
};

type StoredUser = User & {
  password: string;
};

type LoginInput = {
  email: string;
  password: string;
};

function loadUsers(): StoredUser[] {
  try {
    const raw = localStorage.getItem(USERS_KEY);
    const users = raw ? (JSON.parse(raw) as unknown) : [];
    return Array.isArray(users) ? (users as StoredUser[]) : [];
  } catch {
    return [];
  }
}

function saveUsers(users: StoredUser[]): void {
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

export function seedUsersIfEmpty(): void {
  const users = loadUsers();
  if (users.length > 0) return;

  const seeded: StoredUser[] = [
    {
      id: "u1",
      email: "admin@chuwa.com",
      password: "123456",
      role: "admin",
    },
    {
      id: "u2",
      email: "user@chuwa.com",
      password: "123456",
      role: "regular",
    },
  ];

  saveUsers(seeded);
}

export function getSessionUser(): User | null {
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    return raw ? (JSON.parse(raw) as User) : null;
  } catch {
    return null;
  }
}

export function setSessionUser(user: User): void {
  localStorage.setItem(SESSION_KEY, JSON.stringify(user));
}

export function clearSession(): void {
  localStorage.removeItem(SESSION_KEY);
}

export async function loginApi(input: LoginInput): Promise<User> {
  const { email, password } = input;

  // 模拟网络延迟（可删）
  await new Promise((r) => setTimeout(r, 200));

  const users = loadUsers();
  const u = users.find((x) => x.email.toLowerCase() === email.toLowerCase());

  if (!u) {
    const err = new Error("User not found") as Error & { code?: string };
    err.code = "USER_NOT_FOUND";
    throw err;
  }

  if (u.password !== password) {
    const err = new Error("Incorrect password") as Error & { code?: string };
    err.code = "WRONG_PASSWORD";
    throw err;
  }

  const safeUser: User = {
    id: u.id,
    email: u.email,
    role: u.role,
  };

  setSessionUser(safeUser);
  return safeUser;
}

export async function logoutApi(): Promise<boolean> {
  await new Promise((r) => setTimeout(r, 100));
  clearSession();
  return true;
}
